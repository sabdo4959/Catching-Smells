name: Release

on: [workflow_dispatch]

inputs:
  version:
    description: Version Number
    required: true
  release:
    description: Make Release
    required: false
    default: false
  changelog:
    description: Update Changelog
    required: false
    default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: dev
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: 3.9

      - name: Setup Poetry
        uses: abatilo/actions-poetry@v2.1.4
        with:
          poetry-version: 1.1.11

      - name: Extract Release Notes
        run: |
          python ./extract-release-notes.py v${{ inputs.version }}

      - name: Config Git Username
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Update Changelog
        if: ${{ inputs.changelog }}
        run: |
          git add .
          git diff-index --quiet HEAD || git commit -m ":memo: update changelog"
          git push

      - name: Release to Public
        if: ${{ inputs.release }}
        run: |
          poetry config pypi-token.pypi ${{ secrets.PYPI_TOKEN }}
          poetry version ${{ inputs.version }}
          poetry publish --build
          git add .
          git diff-index --quiet HEAD || git commit -m ":sparkles: ${{ inputs.version }}"
          git push
          gh release create "v${{ inputs.version }}" dist/* --notes-file ./release-notes.md --title "âœ¨ v${{ inputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        if: ${{ inputs.release }}
        uses: actions/upload-artifact@v3
        with:
          name: artifacts
          path: dist/

      - name: Merge to Master
        run: |
          git checkout origin/master -b master
          git merge dev --ff-only
          git push --set-upstream origin master
