# 개선된 워크플로우
name: Protobuf Janitor

on:
  schedule:
    # Run daily at 10 AM UTC (2 AM PDT)
    - cron: 0 10 * * *
  workflow_dispatch:

jobs:
  stale-prs:
    name: Close Stale Copybara PRs
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Avoid jobs without timeouts
    permissions:
      pull-requests: write  # Use permissions whenever using Github Token
      contents: read  # Required for reading repository contents

    steps:
      - name: Close stale PRs
        run: |
          set -ex
          STALE_PRS=$(gh pr list --author "app/copybara-service" --limit 500 \
              --json "number" --search "updated:<=$(date --date="-7 day" +%F)" \
            | jq ".[].number")
          for pr in $STALE_PRS; do
            echo "Closing #$pr..."
            gh pr close --comment "Auto-closing Copybara pull request" --delete-branch "$pr"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.event_name != 'fork'  # Avoid executing scheduled workflows on forks